const DB_NAME='calapp';const DB_VER=2;
function openDB(){return new Promise((resolve,reject)=>{const r=indexedDB.open(DB_NAME,DB_VER);r.onupgradeneeded=()=>{const db=r.result;const stores=['user','targets','logs_food','logs_weight','logs_steps','logs_training','logs_hydration','recipes','favourites','checkins','settings','coaching_changes'];stores.forEach(s=>{if(!db.objectStoreNames.contains(s)){db.createObjectStore(s,{keyPath:'id'})}});['logs_food','logs_weight','logs_steps','logs_training','logs_hydration','checkins'].forEach(s=>{const os=r.transaction.objectStore(s);if(os&&!os.indexNames.contains('dateISO'))os.createIndex('dateISO','dateISO',{unique:false})})};r.onsuccess=()=>resolve(r.result);r.onerror=()=>reject(r.error)})}
export async function put(store,obj){const db=await openDB();return new Promise((res,rej)=>{const tx=db.transaction(store,'readwrite');tx.objectStore(store).put(obj);tx.oncomplete=()=>res(obj);tx.onerror=()=>rej(tx.error)})}
export async function get(store,id){const db=await openDB();return new Promise((res,rej)=>{const tx=db.transaction(store);const rq=tx.objectStore(store).get(id);rq.onsuccess=()=>res(rq.result||null);rq.onerror=()=>rej(rq.error)})}
export async function del(store,id){const db=await openDB();return new Promise((res,rej)=>{const tx=db.transaction(store,'readwrite');tx.objectStore(store).delete(id);tx.oncomplete=()=>res();tx.onerror=()=>rej(tx.error)})}
export async function byDate(store,fromISO,toISO){const db=await openDB();return new Promise((res,rej)=>{const tx=db.transaction(store);const idx=tx.objectStore(store).index('dateISO');const range=IDBKeyRange.bound(fromISO,toISO);const out=[];idx.openCursor(range).onsuccess=e=>{const c=e.target.result;if(c){out.push(c.value);c.continue()}else res(out)};tx.onerror=()=>rej(tx.error)})}
export async function wipeAll(){const db=await openDB();return new Promise((res)=>{const names=[...db.objectStoreNames];let left=names.length;names.forEach(s=>{const tx=db.transaction(s,'readwrite');tx.objectStore(s).clear();tx.oncomplete=()=>{if(--left===0)res()}})})}
