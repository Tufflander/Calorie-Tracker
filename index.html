<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Calorie & Macro Tracker — MVP</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    /* ===== Base (dark) design tokens (overridden by theme-glass) ===== */
    :root{
      --bg: #0b1020; --card:#111733; --muted:#7f8ab3; --text:#eaf0ff; --acc:#7ac6ff; --good:#22c55e; --warn:#f59e0b; --bad:#ef4444;
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial; background:var(--bg); color:var(--text)}
    header{padding:20px 16px; border-bottom:1px solid #1e2755; position:sticky; top:0; background:linear-gradient(180deg, rgba(11,16,32,.95), rgba(11,16,32,.7)); backdrop-filter: blur(6px); z-index:2}
    .wrap{max-width:1100px; margin:0 auto; padding:16px}
    h1{margin:0 0 6px; font-size:22px}
    .sub{color:var(--muted); font-size:13px}
    .grid{display:grid; grid-template-columns: 1.1fr 1fr; gap:16px}
    @media (max-width: 900px){.grid{grid-template-columns:1fr}}
    .card{background:var(--card); border:1px solid #1e2755; border-radius:16px; padding:16px; box-shadow: 0 10px 30px rgba(0,0,0,.25)}
    .card h2{margin:0 0 12px; font-size:16px}
    label{display:block; font-size:12px; color:var(--muted); margin:10px 0 6px}
    input, select{width:100%; padding:10px 12px; border-radius:10px; border:1px solid #2a376d; background:#0e1530; color:var(--text)}
    .row{display:grid; grid-template-columns: repeat(4, 1fr); gap:10px}
    .row3{display:grid; grid-template-columns: repeat(3, 1fr); gap:10px}
    .row2{display:grid; grid-template-columns: repeat(2, 1fr); gap:10px}
    .btn{display:inline-flex; align-items:center; gap:8px; padding:10px 14px; border-radius:12px; border:1px solid #2a376d; background:#0e1530; color:var(--text); cursor:pointer}
    .btn.primary{background:linear-gradient(135deg, #2563eb, #06b6d4); border-color:transparent}
    .btn.ghost{background:transparent}
    .kpis{display:grid; grid-template-columns: repeat(3,1fr); gap:12px}
    .kpi{background:#0f1736; border:1px solid #2a376d; border-radius:14px; padding:12px}
    .kpi .v{font-size:18px; font-weight:700}
    .kpi .t{color:var(--muted); font-size:12px}
    table{width:100%; border-collapse:separate; border-spacing:0 8px}
    th, td{font-size:12px; text-align:left; padding:10px 12px}
    thead th{color:var(--muted)}
    tbody tr{background:#0f1736; border:1px solid #223067}
    tbody td:first-child{border-top-left-radius:10px; border-bottom-left-radius:10px}
    tbody td:last-child{border-top-right-radius:10px; border-bottom-right-radius:10px}
    .pill{display:inline-block; padding:2px 8px; border-radius:999px; font-size:11px}
    .pill.ok{background:rgba(34,197,94,.15); color:#4ade80}
    .pill.warn{background:rgba(245,158,11,.15); color:#fbbf24}
    .pill.bad{background:rgba(239,68,68,.15); color:#f87171}
    footer{padding:28px 16px; color:var(--muted); font-size:12px}
    .muted{color:var(--muted)}

    /* ===== Onboarding modal base ===== */
    .modal{position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(15,23,42,.35); backdrop-filter: blur(10px); z-index:30}
    .modal.active{display:flex}
    .panel{width:min(980px, 96vw); background:#0f1736; border:1px solid #2a376d; border-radius:24px; padding:18px}
    .panel h3{margin:0 0 6px; font-size:20px}
    .hint{font-size:12px; color:var(--muted)}
    .danger{color:#b91c1c; font-size:12px}
    .ok{color:#047857; font-size:12px}
    .setup-grid{display:grid; grid-template-columns: 1.2fr .8fr; gap:14px}
    @media (max-width: 900px){ .setup-grid{grid-template-columns:1fr}}
    .preview{background:rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.09); border-radius:16px; padding:12px}
    .pv-title{font-size:13px; color:var(--muted); margin-bottom:6px}
    .pv-row{display:grid; grid-template-columns: 1fr auto; gap:8px; padding:6px 0; font-size:14px}
    .pv-row + .pv-row{border-top:1px dashed rgba(255,255,255,.08)}
    .bar{height:8px; background:rgba(255,255,255,.12); border-radius:999px; overflow:hidden}
    .bar > i{display:block; height:100%; width:0; background:linear-gradient(90deg, #60a5fa, #22d3ee)}

    /* ===== Glass White Theme ===== */
    .theme-glass { --bg:#f7f8fb; --card:rgba(255,255,255,0.65); --text:#0b1220; --muted:#6b7280; --acc:#0ea5e9; }
    .theme-glass body { background: radial-gradient(1200px 800px at 20% -10%, #ffffff 0%, #eef2f7 50%, #e9eef6 100%); }
    .theme-glass header { background: linear-gradient(180deg, rgba(255,255,255,.85), rgba(255,255,255,.65)); border-bottom: 1px solid rgba(15, 23, 42, 0.08); backdrop-filter: saturate(140%) blur(10px); }
    .theme-glass .card, .theme-glass .kpi { background: var(--card); border: 1px solid rgba(15,23,42,.08); border-radius: 24px; box-shadow: 0 10px 30px rgba(15,23,42,0.06), inset 0 1px 0 rgba(255,255,255,0.6); backdrop-filter: blur(12px); }
    .theme-glass input, .theme-glass select { background: rgba(255,255,255,0.9); border: 1px solid rgba(15,23,42,0.12); border-radius: 16px; color: var(--text); }
    .theme-glass .btn { border-radius: 16px; border: 1px solid rgba(15,23,42,0.12); background: rgba(255,255,255,0.8); color: var(--text); }
    .theme-glass .btn.primary { background: linear-gradient(135deg, #60a5fa, #22d3ee); border-color: transparent; box-shadow: 0 8px 18px rgba(59,130,246,0.25); }
    .theme-glass table tbody tr { background: rgba(255,255,255,0.7); border: 1px solid rgba(15,23,42,0.08); }
    .theme-glass .pill.ok  { background: rgba(16,185,129,0.15); color:#059669; }
    .theme-glass .pill.warn{ background: rgba(245,158,11,0.15); color:#b45309; }
    .theme-glass .pill.bad { background: rgba(239,68,68,0.15); color:#b91c1c; }
    .theme-glass canvas { background: transparent; }
    .theme-glass .card:hover { transform: translateY(-2px); transition: transform 180ms ease; }
    .theme-glass .btn:hover  { transform: translateY(-1px); transition: transform 150ms ease; }
    .theme-glass .modal{background:rgba(241,245,249,.5)}
    .theme-glass .panel{background:rgba(255,255,255,.7); border:1px solid rgba(15,23,42,.08); backdrop-filter: blur(16px);}
    .theme-glass .preview{background:rgba(255,255,255,.55); border:1px solid rgba(15,23,42,.08)}
  </style>
</head>
<body class="theme-glass">
  <header>
    <div class="wrap">
      <h1>Calorie & Macro Tracker — MVP</h1>
      <div class="sub">Local-only demo. Data is saved to your browser. Add a plan with Setup, then log your days.</div>
    </div>
  </header>

  <main class="wrap">
    <section class="card" id="setupBanner" style="display:none; margin-bottom:16px">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap">
        <div>
          <strong>No plan yet.</strong>
          <span class="muted">Run the 2‑minute setup to get targets and an 8‑week plan.</span>
        </div>
        <div>
          <button class="btn primary" onclick="openSetup()">Start setup</button>
        </div>
      </div>
    </section>

    <div class="grid">
      <!-- Left: Inputs and Table -->
      <section class="card">
        <h2>Add Daily Entry</h2>
        <div class="row3">
          <div>
            <label>Date</label>
            <input id="date" type="date"/>
          </div>
          <div>
            <label>Body weight (kg)</label>
            <input id="weight" type="number" step="0.1" placeholder="e.g. 78.4"/>
          </div>
          <div>
            <label>Goal weight (kg)</label>
            <input id="goal" type="number" step="0.1" placeholder="e.g. 74"/>
          </div>
        </div>
        <div class="row">
          <div>
            <label>Calories (kcal)</label>
            <input id="kcal" type="number" step="1" placeholder="e.g. 2200"/>
          </div>
          <div>
            <label>Protein (g)</label>
            <input id="protein" type="number" step="1" placeholder="e.g. 165"/>
          </div>
          <div>
            <label>Carbs (g)</label>
            <input id="carbs" type="number" step="1" placeholder="e.g. 210"/>
          </div>
          <div>
            <label>Fat (g)</label>
            <input id="fat" type="number" step="1" placeholder="e.g. 60"/>
          </div>
        </div>
        <div style="margin-top:12px; display:flex; gap:8px; flex-wrap:wrap">
          <button class="btn primary" onclick="addEntry()">Save entry</button>
          <button class="btn" onclick="seedDemo()">Load demo data</button>
          <button class="btn ghost" onclick="clearAll()">Clear all</button>
          <button class="btn" onclick="openSetup()">Re‑run setup</button>
          <button class=\"btn\" onclick=\"getAIInsights()\">AI Insights</button>
          <button class=\"btn\" onclick=\"openCalc()\">Timeframe calc</button>
        </div>

        <div style="margin-top:18px">
          <table>
            <thead>
              <tr>
                <th>Date</th>
                <th>Weight</th>
                <th>kcal</th>
                <th>P</th>
                <th>C</th>
                <th>F</th>
                <th>Est. balance</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="rows"></tbody>
          </table>
        </div>
      </section>

      <!-- Right: KPIs and Charts -->
      <section class="card">
        <h2>Dashboard</h2>
        <div class="kpis">
          <div class="kpi">
            <div class="t">7‑day avg kcal</div>
            <div class="v" id="kpiKcal">—</div>
          </div>
          <div class="kpi">
            <div class="t">Weight trend (7d)</div>
            <div class="v" id="kpiWt">—</div>
          </div>
          <div class="kpi">
            <div class="t">On track</div>
            <div class="v" id="kpiTrack">—</div>
          </div>
        </div>
        <div class="kpis" style="margin-top:12px">
          <div class="kpi">
            <div class="t">Daily kcal target</div>
            <div class="v" id="kpiTargetKcal">—</div>
          </div>
          <div class="kpi">
            <div class="t">Protein target</div>
            <div class="v" id="kpiTargetP">—</div>
          </div>
          <div class="kpi">
            <div class="t">Carb/Fat split</div>
            <div class="v" id="kpiTargetCF">—</div>
          </div>
        </div>
        <div style="margin-top:14px">
          <canvas id="chartWeight" height="180"></canvas>
        </div>
        <div style="margin-top:14px">
          <canvas id="chartKcal" height="180"></canvas>
        </div>
      </section>
    </div>

    <section class="card" style="margin-top:16px">
      <h2>How the AI will plug in (read me)</h2>
      <ol class="muted">
        <li>Deploys as a static site on Vercel. No account needed for the MVP.</li>
        <li>Add a serverless function at <code>/api/insights</code> to call OpenAI later (when you add your API key).</li>
        <li>For multi‑device sync, swap localStorage for Supabase (free tier).</li>
      </ol>
      <p class="muted">“AI Insights” will show a friendly message until <code>/api/insights</code> exists.</p>
    </section>
  </main>

  <!-- Onboarding modal -->
  <div class="modal" id="setupModal" role="dialog" aria-modal="true">
    <div class="panel">
      <h3>Quick setup</h3>
      <p class="hint">Answer a few basics. We’ll calculate safe targets and an 8‑week plan preview.</p>
      <div class="setup-grid">
        <!-- Left: form -->
        <div>
          <div class="row2">
            <div>
              <label>Sex</label>
              <select id="s_sex"><option value="male">Male</option><option value="female">Female</option><option value="na">Prefer not to say</option></select>
            </div>
            <div>
              <label>Age</label>
              <input id="s_age" type="number" min="10" max="100" placeholder="e.g. 30" oninput="previewSetup()"/>
            </div>
          </div>
          <div class="row2">
            <div>
              <label>Height (cm)</label>
              <input id="s_height" type="number" step="1" placeholder="e.g. 178" oninput="previewSetup()"/>
            </div>
            <div>
              <label>Current weight (kg)</label>
              <input id="s_weight" type="number" step="0.1" placeholder="e.g. 78.5" oninput="previewSetup()"/>
            </div>
          </div>
          <div class="row2">
            <div>
              <label>Goal</label>
              <select id="s_goalType" onchange="previewSetup()">
                <option value="lose">Lose fat (deficit)</option>
                <option value="maintain">Maintain</option>
                <option value="gain">Gain muscle (surplus)</option>
              </select>
            </div>
            <div>
              <label>Goal weight (kg)</label>
              <input id="s_goalWeight" type="number" step="0.1" placeholder="optional" oninput="previewSetup()"/>
            </div>
          </div>
          <div class="row2">
            <div>
              <label>Timeframe (weeks)</label>
              <input id="s_weeks" type="number" min="4" max="52" value="8" oninput="previewSetup()"/>
            </div>
            <div>
              <label>Activity level</label>
              <select id="s_activity" onchange="previewSetup()">
                <option value="1.2">Sedentary</option>
                <option value="1.375">Lightly active</option>
                <option value="1.55">Moderately active</option>
                <option value="1.725">Very active</option>
              </select>
            </div>
          </div>

          <details style="margin-top:6px">
            <summary class="hint">Advanced (protein & fat minimums)</summary>
            <div class="row2" style="margin-top:8px">
              <div>
                <label>Protein target (g/kg)</label>
                <input id="s_proteinKg" type="number" step="0.1" value="1.8" oninput="previewSetup()"/>
              </div>
              <div>
                <label>Min dietary fat (g/kg)</label>
                <input id="s_fatMinKg" type="number" step="0.1" value="0.6" oninput="previewSetup()"/>
              </div>
            </div>
          </details>

          <div style="display:flex; gap:8px; margin-top:14px; flex-wrap:wrap">
            <button class="btn primary" id="savePlanBtn" onclick="saveSetup()" disabled>Save plan</button>
            <button class="btn" onclick="closeSetup()">Cancel</button>
            <div class="hint" id="s_msg"></div>
          </div>
        </div>

        <!-- Right: live preview -->
        <div class="preview">
          <div class="pv-title">Plan viability</div>
          <div class="pv-row"><span>Maintenance (TDEE)</span><strong id="pv_tdee">—</strong></div>
          <div class="pv-row"><span>Daily calorie target</span><strong id="pv_kcal">—</strong></div>
          <div class="pv-row"><span>Protein / Fat / Carbs</span><strong id="pv_macros">—</strong></div>
          <div class="pv-row"><span>Weekly pace</span><strong id="pv_pace">—</strong></div>
          <div style="margin:8px 0 4px" class="bar"><i id="pv_bar"></i></div>
          <div id="pv_note" class="hint">Fill in age, height and current weight to get a preview.</div>
          <div id="pv_warn" class="danger" style="display:none; margin-top:6px"></div>
          <div id="pv_ok" class="ok" style="display:none; margin-top:6px"></div>
          <div id="pv_suggest" class="hint" style="margin-top:6px"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Mini Goal Timeframe Calculator -->
  <div class="modal" id="calcModal" role="dialog" aria-modal="true">
    <div class="panel">
      <h3>Goal Timeframe Calculator</h3>
      <p class="hint">Quick estimate based on daily energy change. Uses 7,700 kcal ≈ 1 kg weight change and a simple TDEE ≈ 22 × weight × activity.</p>
      <div class="row3">
        <div>
          <label>Current weight (kg)</label>
          <input id="c_weight" type="number" step="0.1" placeholder="e.g. 78.5" oninput="recalcCalc()" />
        </div>
        <div>
          <label>Target weight (kg)</label>
          <input id="c_target" type="number" step="0.1" placeholder="e.g. 74" oninput="recalcCalc()" />
        </div>
        <div>
          <label>Activity level</label>
          <select id="c_activity" onchange="recalcCalc()">
            <option value="1.2">Sedentary</option>
            <option value="1.375">Lightly active</option>
            <option value="1.55">Moderately active</option>
            <option value="1.725">Very active</option>
          </select>
        </div>
      </div>

      <div class="row2" style="margin-top:8px">
        <div>
          <label>Daily deficit / surplus (kcal)</label>
          <input id="c_deficit" type="number" step="50" value="300" oninput="recalcCalc()"/>
          <div class="hint">Negative = deficit (weight loss), positive = surplus (weight gain). Try −300/−500/−700.</div>
        </div>
        <div>
          <label>Cap (safety)</label>
          <input id="c_cap" type="text" readonly />
          <div class="hint">Limit: min(1000 kcal/day, 25% of estimated TDEE)</div>
        </div>
      </div>

      <div class="preview" style="margin-top:10px">
        <div class="pv-row"><span>Estimated TDEE</span><strong id="c_tdee">—</strong></div>
        <div class="pv-row"><span>Weight to change</span><strong id="c_deltaKg">—</strong></div>
        <div class="pv-row"><span>Pace</span><strong id="c_pace">—</strong></div>
        <div class="pv-row"><span>Estimated timeframe</span><strong id="c_weeks">—</strong></div>
        <div class="pv-row"><span>Target date</span><strong id="c_date">—</strong></div>
        <div id="c_warn" class="danger" style="display:none; margin-top:6px"></div>
        <div id="c_ok" class="ok" style="display:none; margin-top:6px"></div>
      </div>

      <div style="display:flex; gap:8px; margin-top:12px; flex-wrap:wrap">
        <button class="btn" onclick="closeCalc()">Close</button>
      </div>
    </div>
  </div>

  <footer class="wrap">MVP for learning. Not medical advice.</footer>

  <script>
    const $ = (id)=>document.getElementById(id);
    const LS_KEY = 'cal_mvp_entries_v1';
    const PROFILE_KEY = 'cal_profile_v1';
    const TARGETS_KEY = 'cal_targets_v1';

    function load(){ try{ return JSON.parse(localStorage.getItem(LS_KEY)||'[]'); }catch(e){ return []; } }
    function save(list){ localStorage.setItem(LS_KEY, JSON.stringify(list)); render(); }

    function loadProfile(){ try{ return JSON.parse(localStorage.getItem(PROFILE_KEY)||'null'); }catch(e){ return null; } }
    function loadTargets(){ try{ return JSON.parse(localStorage.getItem(TARGETS_KEY)||'null'); }catch(e){ return null; } }

    function saveProfile(p){ localStorage.setItem(PROFILE_KEY, JSON.stringify(p)); }
    function saveTargets(t){ localStorage.setItem(TARGETS_KEY, JSON.stringify(t)); }

    function openSetup(){ $('setupModal').classList.add('active'); $('s_msg').textContent=''; previewSetup(); }
    function closeSetup(){ $('setupModal').classList.remove('active'); render(); }

    function mifflin(heightCm, weightKg, age, sex){
      const s = sex==='male'? 5: sex==='female'? -161: -78; // if unknown, average the constant
      return 10*weightKg + 6.25*heightCm - 5*age + s;
    }

    function computeTargets(p){
      // Estimate maintenance and safe targets
      const BMR = mifflin(p.heightCm, p.weightKg, p.age, p.sex);
      const TDEE = BMR * p.activity;

      const weeks = Math.max(4, Math.min(52, p.weeks||8));
      let dailyKcal = TDEE; // default maintain

      const kgDiff = (p.goalWeightKg? p.goalWeightKg - p.weightKg : 0); // negative if target is lighter
      const kcalPerKg = 7700; // rough estimate

      if(p.goalType==='lose'){
        const bw = p.weightKg;
        // safe weekly loss band: 0.25%–1.0% BW per week
        const minLoss = 0.0025*bw; // kg/week
        const maxLoss = 0.01*bw;   // kg/week
        const neededPerWeek = Math.abs(kgDiff)/weeks || minLoss; // positive number
        const chosenPerWeek = Math.min(Math.max(neededPerWeek, minLoss), maxLoss);
        let dailyDeficit = (chosenPerWeek * kcalPerKg) / 7;
        const cap = Math.min(1000, 0.25*TDEE);
        dailyDeficit = Math.min(dailyDeficit, cap);
        dailyKcal = Math.max(1200, Math.round(TDEE - dailyDeficit));
      }
      if(p.goalType==='gain'){
        // modest surplus 250‑350 kcal/day
        const surplus = 300;
        dailyKcal = Math.round(TDEE + surplus);
      }

      // macros
      const proteinG = Math.round(p.proteinPerKg * p.weightKg);
      const fatMinG = Math.round(p.fatMinPerKg * p.weightKg);
      const fatG = Math.max(fatMinG, Math.round(0.25*dailyKcal/9));
      const carbsG = Math.max(0, Math.round((dailyKcal - proteinG*4 - fatG*9)/4));

      return { TDEE: Math.round(TDEE), dailyKcal, proteinG, fatG, carbsG };
    }

    function previewSetup(){
      const msg = (t)=>{ $('s_msg').textContent = t||''; };
      const get = (id)=> $(id).value;
      const num = (id)=> parseFloat($(id).value||'');

      const age = parseInt(get('s_age')||'0',10);
      const height = num('s_height');
      const weight = num('s_weight');
      const goalType = get('s_goalType');
      const goalW = num('s_goalWeight')||null;
      const weeks = Math.max(4, Math.min(52, parseInt(get('s_weeks')||'8',10)));
      const activity = parseFloat(get('s_activity')||'1.2');
      const proteinPerKg = parseFloat(get('s_proteinKg')||'1.8');
      const fatMinPerKg = parseFloat(get('s_fatMinKg')||'0.6');

      const canCalc = age && height && weight;
      $('savePlanBtn').disabled = !canCalc;

      if(!canCalc){
        $('pv_tdee').textContent='—';
        $('pv_kcal').textContent='—';
        $('pv_macros').textContent='—';
        $('pv_pace').textContent='—';
        $('pv_bar').style.width='0%';
        $('pv_note').style.display='block';
        $('pv_warn').style.display='none';
        $('pv_ok').style.display='none';
        $('pv_suggest').textContent='';
        return;
      }

      const p = { sex:get('s_sex'), age, heightCm:height, weightKg:weight, goalType, goalWeightKg:goalW, weeks, activity, proteinPerKg, fatMinPerKg };
      const t = computeTargets(p);

      $('pv_tdee').textContent = t.TDEE + ' kcal';
      $('pv_kcal').textContent = t.dailyKcal + ' kcal';
      $('pv_macros').textContent = `${t.proteinG} P / ${t.fatG} F / ${t.carbsG} C`;

      // Pace + viability
      let pace = 0; // kg/week (negative = losing)
      let warn = '';
      const bw = weight;
      if(goalW){ pace = (goalW - weight) / weeks; }
      const minLoss = -0.01*bw;   // -1.0%/wk
      const softLoss = -0.007*bw; // -0.7%/wk
      const okLoss = -0.0025*bw;  // -0.25%/wk
      const minGain = 0.1;        // kg/week (rough, muscle gain is slow)
      const maxGain = 0.4;

      if(goalType==='lose' && goalW){
        $('pv_pace').textContent = pace.toFixed(2) + ' kg/wk';
        const pct = Math.max(0, Math.min(1, Math.abs(pace)/Math.abs(minLoss)));
        $('pv_bar').style.width = (pct*100).toFixed(0)+'%';
        if(pace < minLoss){ warn = 'Too aggressive. Aim for 0.25%–1.0% bodyweight loss per week.'; }
        else if(pace > okLoss){ warn = 'Very slow loss. Consider a slightly larger deficit.'; }
      } else if(goalType==='gain' && goalW){
        $('pv_pace').textContent = '+'+pace.toFixed(2) + ' kg/wk';
        const pct = Math.max(0, Math.min(1, (pace - minGain) / (maxGain - minGain)));
        $('pv_bar').style.width = (pct*100).toFixed(0)+'%';
        if(pace > maxGain){ warn = 'Surplus may be too high; risk of excess fat gain.'; }
        else if(pace < minGain){ warn = 'Gain pace is very slow; ensure sufficient surplus and protein.'; }
      } else {
        $('pv_pace').textContent = '—'; $('pv_bar').style.width='0%';
      }

      // Suggest timeframe if needed
      let suggest='';
      if(goalW && goalType!=='maintain'){
        const delta = Math.abs(goalW - weight);
        if(goalType==='lose'){
          const weeksFast = Math.ceil(delta / Math.abs(minLoss));
          const weeksSoft = Math.ceil(delta / Math.abs(softLoss));
          suggest = `Suggested timeframe: ${weeksSoft}–${weeksFast} weeks for a safe rate.`;
        } else {
          const weeksMin = Math.ceil(delta / minGain);
          const weeksMax = Math.ceil(delta / maxGain);
          suggest = `Suggested timeframe: ${weeksMax}–${weeksMin} weeks depending on surplus.`;
        }
      }

      $('pv_note').style.display='none';
      if(warn){ $('pv_warn').style.display='block'; $('pv_warn').textContent = warn; $('pv_ok').style.display='none'; }
      else { $('pv_warn').style.display='none'; $('pv_ok').style.display='block'; $('pv_ok').textContent='Looks viable. You can save this plan.'; }
      $('pv_suggest').textContent = suggest;
    }

    function saveSetup(){
      const p = {
        sex: $('s_sex').value,
        age: parseInt($('s_age').value||'0',10),
        heightCm: parseFloat($('s_height').value||'0'),
        weightKg: parseFloat($('s_weight').value||'0'),
        goalType: $('s_goalType').value,
        goalWeightKg: parseFloat($('s_goalWeight').value||'') || null,
        weeks: parseInt($('s_weeks').value||'8',10),
        activity: parseFloat($('s_activity').value||'1.2'),
        proteinPerKg: parseFloat($('s_proteinKg').value||'1.8'),
        fatMinPerKg: parseFloat($('s_fatMinKg').value||'0.6')
      };

      if(!p.age || !p.heightCm || !p.weightKg){ $('s_msg').textContent = 'Please fill age, height and current weight.'; return; }

      const t = computeTargets(p);
      saveProfile(p); saveTargets(t);
      $('s_msg').textContent = 'Saved. Closing…';
      setTimeout(()=>{ closeSetup(); }, 400);
    }

    function addEntry(){
      const date = $('date').value || new Date().toISOString().slice(0,10);
      const weight = parseFloat($('weight').value||'');
      const goal = parseFloat($('goal').value||'');
      const kcal = parseFloat($('kcal').value||'');
      const protein = parseFloat($('protein').value||'');
      const carbs = parseFloat($('carbs').value||'');
      const fat = parseFloat($('fat').value||'');
      if(isNaN(weight)||isNaN(kcal)){
        alert('Please enter at least weight and calories');
        return;
      }
      const list = load();
      const id = date+':'+(Math.random()+"").slice(2,7);
      list.push({id, date, weight, goal: isNaN(goal)? null: goal, kcal, protein: protein||0, carbs: carbs||0, fat: fat||0});
      list.sort((a,b)=> a.date.localeCompare(b.date));
      save(list);
      ['weight','goal','kcal','protein','carbs','fat'].forEach(k=>{ $(k).value=''; });
    }

    function removeEntry(id){ save(load().filter(x=>x.id!==id)); }

    function clearAll(){ if(confirm('Delete all local data?')){ localStorage.removeItem(LS_KEY); render(); } }

    function kcalBalance(kcal, target){ if(!target) return null; return Math.round(kcal - target); }

    function weightTrendKgPerWeek(points){
      const ys = points.filter(x=>!isNaN(x));
      if(ys.length<2) return 0;
      const xs = ys.map((_,i)=> i);
      const n = xs.length; const sx=xs.reduce((a,b)=>a+b,0); const sy=ys.reduce((a,b)=>a+b,0);
      const sxy=xs.reduce((a,x,i)=>a+x*ys[i],0); const sxx=xs.reduce((a,x)=>a+x*x,0);
      const slope = (n*sxy - sx*sy)/(n*sxx - sx*sx || 1);
      return slope*7; // kg per week
    }

    let chartW=null, chartK=null;
    function render(){
      const list = load();
      const prof = loadProfile();
      const targ = loadTargets();

      $('setupBanner').style.display = prof? 'none':'block';

      const tbody = $('rows');
      tbody.innerHTML='';
      const TDEE_TARGET = targ?.dailyKcal || 2200; // temp fallback
      const labels = list.map(x=>x.date);
      const weights = list.map(x=>x.weight);
      const kcals = list.map(x=>x.kcal);

      for(const row of list){
        const tr = document.createElement('tr');
        const bal = kcalBalance(row.kcal, TDEE_TARGET);
        const pill = bal==null? '': `<span class="pill ${bal< -300? 'ok': bal<200? 'warn':'bad'}">${bal>0?'+':''}${bal||0}</span>`;
        tr.innerHTML = `
          <td>${row.date}</td>
          <td>${row.weight?.toFixed(1)||''}</td>
          <td>${row.kcal||''}</td>
          <td>${row.protein||''}</td>
          <td>${row.carbs||''}</td>
          <td>${row.fat||''}</td>
          <td>${pill}</td>
          <td><button class="btn" onclick="removeEntry('${row.id}')">Delete</button></td>`;
        tbody.appendChild(tr);
      }

      // KPIs
      const last7 = kcals.slice(-7);
      const avg7 = last7.length? Math.round(last7.reduce((a,b)=>a+b,0)/last7.length): null;
      $('kpiKcal').textContent = avg7? avg7+' kcal': '—';

      const wtTrend = weightTrendKgPerWeek(weights);
      $('kpiWt').textContent = (wtTrend>0? '+':'') + wtTrend.toFixed(2) + ' kg/wk';

      const onTrack = wtTrend < -0.25 && wtTrend > -1.0; // rough band
      $('kpiTrack').innerHTML = onTrack? '<span class="pill ok">Yes</span>': '<span class="pill warn">Needs review</span>';

      $('kpiTargetKcal').textContent = targ? targ.dailyKcal + ' kcal' : '—';
      $('kpiTargetP').textContent = targ? targ.proteinG + ' g' : '—';
      $('kpiTargetCF').textContent = targ? `${targ.carbsG} C / ${targ.fatG} F` : '—';

      // charts
      const ctxW = $('chartWeight').getContext('2d');
      const ctxK = $('chartKcal').getContext('2d');
      chartW && chartW.destroy();
      chartK && chartK.destroy();
      chartW = new Chart(ctxW, {
        type:'line',
        data:{ labels, datasets:[{ label:'Weight (kg)', data: weights, tension:.3, fill:false }]},
        options:{ plugins:{legend:{display:false}}, scales:{ x:{ ticks:{ color:'#9aa6d1'}}, y:{ ticks:{ color:'#9aa6d1'}}}}
      });
      chartK = new Chart(ctxK, {
        type:'bar',
        data:{ labels, datasets:[{ label:'Calories', data: kcals }]},
        options:{ plugins:{legend:{display:false}}, scales:{ x:{ ticks:{ color:'#9aa6d1'}}, y:{ ticks:{ color:'#9aa6d1'}}}}
      });
    }

    async function getAIInsights(){
      const entries = load();
      try{
        const r = await fetch('/api/insights', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ entries })});
        if(!r.ok) throw new Error('No API route yet');
        const data = await r.json();
        alert(data.advice || 'No advice');
      }catch(e){
        alert('To enable AI: add /api/insights and OPENAI_API_KEY in Vercel later.');
      }
    }

    function seedDemo(){
      const today = new Date();
      const list=[]; let w=78.6; let kcal=2300;
      for(let i=13;i>=0;i--){
        const d = new Date(today); d.setDate(today.getDate()-i);
        w += (Math.random()-.55)*0.25; // slight down trend
        kcal += (Math.random()-.4)*150;
        list.push({
          id: d.toISOString()+Math.random(),
          date: d.toISOString().slice(0,10),
          weight: Math.round(w*10)/10,
          goal: 74,
          kcal: Math.round(kcal),
          protein: 160 + Math.round(Math.random()*20),
          carbs: 180 + Math.round(Math.random()*40),
          fat: 60 + Math.round(Math.random()*10)
        });
      }
      localStorage.setItem(LS_KEY, JSON.stringify(list));
      render();
    }

    // init
    (function(){
      const d = new Date().toISOString().slice(0,10);
      $('date').value = d;
      render();
      if(!loadProfile()) openSetup();
      window.addEventListener('load', ()=> setTimeout(previewSetup, 100));
    })();
  function openCalc(){ $('calcModal').classList.add('active'); recalcCalc(); }
    function closeCalc(){ $('calcModal').classList.remove('active'); }

    function recalcCalc(){
      const w = parseFloat(($('c_weight').value||'').trim());
      const t = parseFloat(($('c_target').value||'').trim());
      const act = parseFloat($('c_activity').value||'1.2');
      let d = parseFloat(($('c_deficit').value||'0').trim());

      const kcalPerKg = 7700;
      const can = !isNaN(w) && !isNaN(t) && w>0 && t>0;

      if(!can){
        ['c_tdee','c_deltaKg','c_pace','c_weeks','c_date'].forEach(id=>$(id).textContent='—');
        $('c_warn').style.display='none'; $('c_ok').style.display='none';
        $('c_cap').value = '';
        return;
      }

      // Simple TDEE estimate without height/age: RMR ≈ 22*kgs, TDEE = RMR*activity
      const TDEE = Math.round(22 * w * act);
      const cap = Math.min(1000, Math.round(0.25*TDEE));
      $('c_cap').value = cap + ' kcal/day max';

      // enforce cap
      if(Math.abs(d) > cap){ d = Math.sign(d) * cap; $('c_deficit').value = d; }

      const deltaKg = +(t - w).toFixed(1);
      const perDay = Math.abs(d);
      const weeks = perDay>0 ? Math.ceil(Math.abs(deltaKg) * kcalPerKg / (perDay*7)) : 0;
      
      // weekly pace kg/wk
      const pace = perDay>0 ? (perDay*7 / kcalPerKg) : 0; // positive pace in kg/wk (abs)

      $('c_tdee').textContent = TDEE + ' kcal/day';
      $('c_deltaKg').textContent = (deltaKg>0? '+':'') + deltaKg + ' kg';
      $('c_pace').textContent = (d<0? '-':'+' ) + pace.toFixed(2) + ' kg/wk';
      $('c_weeks').textContent = weeks? weeks + ' weeks' : '—';

      if(weeks){
        const date = new Date(); date.setDate(date.getDate()+weeks*7);
        $('c_date').textContent = date.toISOString().slice(0,10);
      } else {
        $('c_date').textContent = '—';
      }

      // Safety messaging relative to BW
      const pctBW = (pace / w) * 100; // weekly percent change
      let warn='';
      if(d<0 && pctBW>1.0){ warn='Loss pace is aggressive (>1% BW/week). Consider a smaller deficit.'; }
      if(d>0 && pace>0.4){ warn='Gain pace is aggressive (>0.4 kg/week). Consider a smaller surplus.'; }
      if(warn){ $('c_warn').style.display='block'; $('c_warn').textContent=warn; $('c_ok').style.display='none'; }
      else{ $('c_warn').style.display='none'; $('c_ok').style.display='block'; $('c_ok').textContent='Looks viable based on current inputs.'; }
    }
  </script>
</body>
</html>
